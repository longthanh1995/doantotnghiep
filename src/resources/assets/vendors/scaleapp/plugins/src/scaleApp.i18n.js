// Generated by CoffeeScript 1.10.0
(function() {
  var plugin,
    slice = [].slice;

  plugin = function(core) {
    var _, addLocal, baseLanguage, channelName, get, getBrowserLanguage, getLanguage, getText, global, lang, mediator, onChange, setGlobal, setLanguage, unsubscribe;
    baseLanguage = "en";
    getBrowserLanguage = function() {
      return ((typeof navigator !== "undefined" && navigator !== null ? navigator.language : void 0) || (typeof navigator !== "undefined" && navigator !== null ? navigator.browserLanguage : void 0) || baseLanguage).split("-")[0];
    };
    channelName = "i18n";
    getText = function(key, x, l, global) {
      var ref, ref1;
      return ((ref = x[l]) != null ? ref[key] : void 0) || ((ref1 = global[l]) != null ? ref1[key] : void 0);
    };
    get = function(key, x, lang, global) {
      if (x == null) {
        x = {};
      }
      if (lang == null) {
        lang = "";
      }
      return getText(key, x, lang, global) || getText(key, x, lang.substring(0, 2), global) || getText(key, x, baseLanguage, global) || key;
    };
    addLocal = function(dict, i18n) {
      var k, lang, results, txt, v;
      if (typeof dict !== "object") {
        return false;
      }
      results = [];
      for (lang in dict) {
        txt = dict[lang];
        if (i18n[lang] == null) {
          i18n[lang] = {};
        }
        results.push((function() {
          var base, results1;
          results1 = [];
          for (k in txt) {
            v = txt[k];
            results1.push((base = i18n[lang])[k] != null ? base[k] : base[k] = v);
          }
          return results1;
        })());
      }
      return results;
    };
    mediator = new core.Mediator;
    lang = getBrowserLanguage();
    global = {};
    core.getBrowserLanguage = getBrowserLanguage;
    core.baseLanguage = baseLanguage;
    getLanguage = function() {
      return lang;
    };
    unsubscribe = function() {
      return mediator.off.apply(mediator, [channelName].concat(slice.call(arguments)));
    };
    onChange = function() {
      return mediator.on.apply(mediator, [channelName].concat(slice.call(arguments)));
    };
    setLanguage = function(code) {
      if (typeof code === "string") {
        lang = code;
        return mediator.emit(channelName, lang);
      }
    };
    setGlobal = function(obj) {
      if (typeof obj === "object") {
        global = obj;
        return true;
      } else {
        return false;
      }
    };
    _ = function(text, o) {
      return get(text, o, lang, global);
    };
    core.i18n = {
      setLanguage: setLanguage,
      getLanguage: getLanguage,
      setGlobal: setGlobal,
      onChange: onChange,
      _: _,
      unsubscribe: unsubscribe
    };
    core.Sandbox.prototype.i18n = {
      onChange: onChange,
      unsubscribe: unsubscribe,
      getLanguage: getLanguage
    };
    return {
      id: "i18n",
      init: function(sb) {
        sb.i18n.addLocal = function(dict) {
          var base;
          if ((base = sb.options).i18n == null) {
            base.i18n = {};
          }
          return addLocal(dict, sb.options.i18n);
        };
        return sb._ = (function(_this) {
          return function(text) {
            return _(text, sb.options.localDict || sb.options.i18n);
          };
        })(this);
      }
    };
  };

  if ((typeof define !== "undefined" && define !== null ? define.amd : void 0) != null) {
    define(function() {
      return plugin;
    });
  } else if ((typeof window !== "undefined" && window !== null ? window.scaleApp : void 0) != null) {
    window.scaleApp.plugins.i18n = plugin;
  } else if ((typeof module !== "undefined" && module !== null ? module.exports : void 0) != null) {
    module.exports = plugin;
  }

}).call(this);
